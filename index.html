<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cansu's Wonderland</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .radio-player {
            background: white;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .cover-art {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            background: #ddd;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 10px;
        }

        .cover-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .cover-art img.loaded {
            display: block;
        }

        .track-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 0;
        }

        .track-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #333;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .track-artist {
            font-size: 13px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-controls {
            flex-shrink: 0;
            width: 250px;
        }

        .player-controls audio {
            width: 100%;
        }

        .yuri-gallery {
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .gallery-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #333;
        }

        .gallery-container {
            position: relative;
            height: 400px;
            overflow: hidden;
        }

        .gallery-scroll {
            display: flex;
            gap: 15px;
            animation: scroll 30s linear infinite;
            will-change: transform;
        }

        .gallery-scroll:hover {
            animation-play-state: paused;
        }

        .gallery-scroll.paused {
            animation-play-state: paused;
        }

        .yuri-item {
            flex-shrink: 0;
            width: 300px;
            height: 400px;
            position: relative;
            border: 2px solid #eee;
            transition: transform 0.3s ease;
        }

        .yuri-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .yuri-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .source-link {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 12px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 12px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .source-link:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.9);
        }

        .yuri-item:first-child,
        .yuri-item:nth-last-child(-n+2) {
            opacity: 0.3;
        }

        @keyframes scroll {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(calc(-315px * 10));
            }
        }

        .loading {
            color: #999;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .gallery-controls {
            background: white;
            padding: 15px;
            margin-top: 10px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gallery-controls label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .gallery-controls input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        @media (max-width: 600px) {
            .radio-player {
                flex-direction: column;
            }

            .player-controls {
                width: 100%;
            }

            .yuri-item {
                width: 250px;
                height: 350px;
            }

            @keyframes scroll {
                0% {
                    transform: translateX(0);
                }
                100% {
                    transform: translateX(calc(-265px * 10));
                }
            }
        }
    </style>
</head>
<body>
    <div class="radio-player">
        <div class="cover-art" id="coverArt">
            <img id="coverImage" alt="Album cover">
        </div>
        <div class="track-details">
            <div class="track-title" id="trackTitle">woagh... girls are... kissing?</div>
            <div class="track-artist" id="trackArtist">focus, m.</div>
        </div>
        <div class="player-controls">
            <audio id="player" controls preload="none" playsinline>
                <source src="https://radio.cansu.dev/beep" type="audio/mpeg">
                <source src="https://radio.cansu.dev/beep" type="audio/ogg">
                Your browser does not support the audio element.
            </audio>
        </div>
    </div>

    <div class="yuri-gallery">
        <div class="gallery-container">
            <div class="gallery-scroll" id="galleryScroll">
                <div class="loading">loading peak</div>
            </div>
        </div>
    </div>

    <div class="gallery-controls">
        <label>
            <input type="checkbox" id="autoFetchToggle" checked>
            Auto-refresh gallery
        </label>
    </div>

    <script>
        const audioPlayer = document.getElementById('player');
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 10;

        audioPlayer.addEventListener('error', function() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(() => {
                    audioPlayer.load();
                }, 3000);
            }
        });

        audioPlayer.addEventListener('stalled', function() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                setTimeout(() => {
                    audioPlayer.load();
                }, 2000);
            }
        });

        audioPlayer.addEventListener('canplay', function() {
            reconnectAttempts = 0;
        });

        audioPlayer.addEventListener('playing', function() {
            reconnectAttempts = 0;
        });

        let currentTrack = null;
        let currentArtist = null;

        async function fetchNowPlaying() {
            try {
                const response = await fetch('https://radio.cansu.dev/status-json.xsl');
                const data = await response.json();

                if (data.icestats && data.icestats.source) {
                    const source = data.icestats.source;
                    const artist = source.artist || '';
                    const title = source.title || '';

                    if (currentTrack !== title || currentArtist !== artist) {
                        currentTrack = title;
                        currentArtist = artist;

                        document.getElementById('trackTitle').textContent = title || 'Unknown Track';
                        document.getElementById('trackArtist').textContent = artist || 'Unknown Artist';

                        if (artist && title) {
                            fetchCoverArt(artist, title);
                        } else {
                            hideCoverArt();
                        }
                    }
                }
            } catch (error) {
                console.error('Error fetching now playing:', error);
                document.getElementById('trackTitle').textContent = 'Unable to load track info';
            }
        }

        async function fetchCoverArt(artist, title) {
            try {
                const searchQuery = encodeURIComponent(`artist:"${artist}" AND recording:"${title}"`);
                const searchUrl = `https://musicbrainz.org/ws/2/recording/?query=${searchQuery}&fmt=json&limit=1`;

                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                const recording = searchData.recordings?.[0];
                const releaseId = recording?.releases?.[0]?.id;

                if (releaseId) {
                    const coverUrl = `https://coverartarchive.org/release/${releaseId}/front-250`;
                    const coverResponse = await fetch(coverUrl, { method: 'HEAD' });
                    
                    if (coverResponse.ok) {
                        showCoverArt(coverUrl);
                        return;
                    }
                }
            } catch (error) {
                console.error('Error fetching cover art:', error);
            }
            
            hideCoverArt();
        }

        function showCoverArt(url) {
            const img = document.getElementById('coverImage');
            img.src = url;
            img.onload = function() {
                img.classList.add('loaded');
            };
        }

        function hideCoverArt() {
            const img = document.getElementById('coverImage');
            img.classList.remove('loaded');
            img.src = '';
        }

        let yuriImageCache = [];
        let isLoadingYuri = false;
        let autoFetchEnabled = true;
        let fetchInterval = null;
        const tagSets = [
            'yuri+touhou+-loli',
            'yuri+genshin_impact+-loli',
            'yuri+bocchi_the_rock+-loli'
        ];
        let currentTagIndex = 0;

        function getRandomPage() {
            return Math.floor(Math.random() * 100);
        }

        function getNextTags() {
            const tags = tagSets[currentTagIndex];
            currentTagIndex = (currentTagIndex + 1) % tagSets.length;
            return tags;
        }

        async function fetchYuriImages() {
            if (isLoadingYuri) return;
            isLoadingYuri = true;

            try {
                const page = getRandomPage();
                const tags = getNextTags();
                const response = await fetch(`/api/yuri?page=${page}&limit=20&tags=${encodeURIComponent(tags)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    yuriImageCache.push(...data);

                    if (yuriImageCache.length > 50) {
                        yuriImageCache = yuriImageCache.slice(-50);
                    }

                    updateGalleryDisplay();
                }
            } catch (error) {
                if (yuriImageCache.length === 0) {
                    document.getElementById('galleryScroll').innerHTML = '<div class="loading">Failed to load images.</div>';
                }
            } finally {
                isLoadingYuri = false;
            }
        }

        function updateGalleryDisplay() {
            const galleryScroll = document.getElementById('galleryScroll');

            if (yuriImageCache.length === 0) return;

            galleryScroll.innerHTML = '';

            [...yuriImageCache, ...yuriImageCache].forEach((item, index) => {
                const yuriItem = document.createElement('div');
                yuriItem.className = 'yuri-item';

                const img = document.createElement('img');
                img.src = item.sample_url || item.file_url;
                img.alt = 'Yuri image';
                img.loading = 'lazy';

                yuriItem.appendChild(img);

                if (item.source) {
                    const sourceLink = document.createElement('a');
                    sourceLink.href = item.source;
                    sourceLink.className = 'source-link';
                    sourceLink.textContent = 'source';
                    sourceLink.target = '_blank';
                    sourceLink.rel = 'noopener noreferrer';
                    yuriItem.appendChild(sourceLink);
                }

                galleryScroll.appendChild(yuriItem);
            });
        }

        function toggleAutoFetch(enabled) {
            autoFetchEnabled = enabled;
            const galleryScroll = document.getElementById('galleryScroll');

            if (enabled) {
                galleryScroll.classList.remove('paused');
                if (!fetchInterval) {
                    fetchInterval = setInterval(() => {
                        if (autoFetchEnabled) {
                            fetchYuriImages();
                        }
                    }, 10000);
                }
            } else {
                galleryScroll.classList.add('paused');
                if (fetchInterval) {
                    clearInterval(fetchInterval);
                    fetchInterval = null;
                }
            }
        }

        document.getElementById('autoFetchToggle').addEventListener('change', function(e) {
            toggleAutoFetch(e.target.checked);
        });

        fetchNowPlaying();
        setInterval(fetchNowPlaying, 10000);

        fetchYuriImages();
        fetchInterval = setInterval(() => {
            if (autoFetchEnabled) {
                fetchYuriImages();
            }
        }, 10000);
    </script>
</body>
</html>
